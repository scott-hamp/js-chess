var Chess=function(fen){var BLACK="b",WHITE="w",EMPTY=-1,PAWN="p",KNIGHT="n",BISHOP="b",ROOK="r",QUEEN="q",KING="k",SYMBOLS="pnbrqkPNBRQK",DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",POSSIBLE_RESULTS=["1-0","0-1","1/2-1/2","*"],PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},PIECE_OFFSETS={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5},FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},RANK_1=7,RANK_2=6,RANK_3=5,RANK_4=4,RANK_5=3,RANK_6=2,RANK_7=1,RANK_8=0,SQUARES={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ROOKS={w:[{square:SQUARES.a1,flag:BITS.QSIDE_CASTLE},{square:SQUARES.h1,flag:BITS.KSIDE_CASTLE}],b:[{square:SQUARES.a8,flag:BITS.QSIDE_CASTLE},{square:SQUARES.h8,flag:BITS.KSIDE_CASTLE}]},board=new Array(128),kings={w:-1,b:-1},turn="w",castling={w:0,b:0},ep_square=-1,half_moves=0,move_number=1,history=[],header={},comments={};function clear(keep_headers){void 0===keep_headers&&(keep_headers=!1),board=new Array(128),kings={w:-1,b:-1},turn="w",castling={w:0,b:0},ep_square=-1,half_moves=0,move_number=1,history=[],keep_headers||(header={}),comments={},update_setup(generate_fen())}function prune_comments(){for(var reversed_history=[],current_comments={},copy_comment=function(fen){fen in comments&&(current_comments[fen]=comments[fen])};history.length>0;)reversed_history.push(undo_move());for(copy_comment(generate_fen());reversed_history.length>0;)make_move(reversed_history.pop()),copy_comment(generate_fen());comments=current_comments}function reset(){load(DEFAULT_POSITION)}function load(fen,keep_headers){void 0===keep_headers&&(keep_headers=!1);var tokens=fen.split(/\s+/),position=tokens[0],square=0;if(!validate_fen(fen).valid)return!1;clear(keep_headers);for(var i=0;i<position.length;i++){var piece=position.charAt(i);if("/"===piece)square+=8;else if(is_digit(piece))square+=parseInt(piece,10);else{var color=piece<"a"?"w":"b";put({type:piece.toLowerCase(),color:color},algebraic(square)),square++}}return turn=tokens[1],tokens[2].indexOf("K")>-1&&(castling.w|=BITS.KSIDE_CASTLE),tokens[2].indexOf("Q")>-1&&(castling.w|=BITS.QSIDE_CASTLE),tokens[2].indexOf("k")>-1&&(castling.b|=BITS.KSIDE_CASTLE),tokens[2].indexOf("q")>-1&&(castling.b|=BITS.QSIDE_CASTLE),ep_square="-"===tokens[3]?-1:SQUARES[tokens[3]],half_moves=parseInt(tokens[4],10),move_number=parseInt(tokens[5],10),update_setup(generate_fen()),!0}function validate_fen(fen){var errors_0="No errors.",errors_1="FEN string must contain six space-delimited fields.",errors_2="6th field (move number) must be a positive integer.",errors_3="5th field (half move counter) must be a non-negative integer.",errors_4="4th field (en-passant square) is invalid.",errors_5="3rd field (castling availability) is invalid.",errors_6="2nd field (side to move) is invalid.",errors_7="1st field (piece positions) does not contain 8 '/'-delimited rows.",errors_8="1st field (piece positions) is invalid [consecutive numbers].",errors_9="1st field (piece positions) is invalid [invalid piece].",errors_10="1st field (piece positions) is invalid [row too large].",errors_11="Illegal en-passant square",tokens=fen.split(/\s+/);if(6!==tokens.length)return{valid:!1,error_number:1,error:errors_1};if(isNaN(tokens[5])||parseInt(tokens[5],10)<=0)return{valid:!1,error_number:2,error:errors_2};if(isNaN(tokens[4])||parseInt(tokens[4],10)<0)return{valid:!1,error_number:3,error:errors_3};if(!/^(-|[abcdefgh][36])$/.test(tokens[3]))return{valid:!1,error_number:4,error:errors_4};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(tokens[2]))return{valid:!1,error_number:5,error:errors_5};if(!/^(w|b)$/.test(tokens[1]))return{valid:!1,error_number:6,error:errors_6};var rows=tokens[0].split("/");if(8!==rows.length)return{valid:!1,error_number:7,error:errors_7};for(var i=0;i<rows.length;i++){for(var sum_fields=0,previous_was_number=!1,k=0;k<rows[i].length;k++)if(isNaN(rows[i][k])){if(!/^[prnbqkPRNBQK]$/.test(rows[i][k]))return{valid:!1,error_number:9,error:errors_9};sum_fields+=1,previous_was_number=!1}else{if(previous_was_number)return{valid:!1,error_number:8,error:errors_8};sum_fields+=parseInt(rows[i][k],10),previous_was_number=!0}if(8!==sum_fields)return{valid:!1,error_number:10,error:errors_10}}return"3"==tokens[3][1]&&"w"==tokens[1]||"6"==tokens[3][1]&&"b"==tokens[1]?{valid:!1,error_number:11,error:errors_11}:{valid:!0,error_number:0,error:errors_0}}function generate_fen(){for(var empty=0,fen="",i=SQUARES.a8;i<=SQUARES.h1;i++){if(null==board[i])empty++;else{empty>0&&(fen+=empty,empty=0);var color=board[i].color,piece=board[i].type;fen+="w"===color?piece.toUpperCase():piece.toLowerCase()}i+1&136&&(empty>0&&(fen+=empty),i!==SQUARES.h1&&(fen+="/"),empty=0,i+=8)}var cflags="";castling.w&BITS.KSIDE_CASTLE&&(cflags+="K"),castling.w&BITS.QSIDE_CASTLE&&(cflags+="Q"),castling.b&BITS.KSIDE_CASTLE&&(cflags+="k"),castling.b&BITS.QSIDE_CASTLE&&(cflags+="q"),cflags=cflags||"-";var epflags=-1===ep_square?"-":algebraic(ep_square);return[fen,turn,cflags,epflags,half_moves,move_number].join(" ")}function set_header(args){for(var i=0;i<args.length;i+=2)"string"==typeof args[i]&&"string"==typeof args[i+1]&&(header[args[i]]=args[i+1]);return header}function update_setup(fen){history.length>0||(fen!==DEFAULT_POSITION?(header.SetUp="1",header.FEN=fen):(delete header.SetUp,delete header.FEN))}function get(square){var piece=board[SQUARES[square]];return piece?{type:piece.type,color:piece.color}:null}function put(piece,square){if(!("type"in piece&&"color"in piece))return!1;if(-1===SYMBOLS.indexOf(piece.type.toLowerCase()))return!1;if(!(square in SQUARES))return!1;var sq=SQUARES[square];return("k"!=piece.type||-1==kings[piece.color]||kings[piece.color]==sq)&&(board[sq]={type:piece.type,color:piece.color},"k"===piece.type&&(kings[piece.color]=sq),update_setup(generate_fen()),!0)}function remove(square){var piece=get(square);return board[SQUARES[square]]=null,piece&&"k"===piece.type&&(kings[piece.color]=-1),update_setup(generate_fen()),piece}function build_move(board,from,to,flags,promotion){var move={color:turn,from:from,to:to,flags:flags,piece:board[from].type};return promotion&&(move.flags|=BITS.PROMOTION,move.promotion=promotion),board[to]?move.captured=board[to].type:flags&BITS.EP_CAPTURE&&(move.captured="p"),move}function generate_moves(options){function add_move(board,moves,from,to,flags){if("p"!==board[from].type||0!==rank(to)&&7!==rank(to))moves.push(build_move(board,from,to,flags));else for(var pieces=["q","r","b","n"],i=0,len=pieces.length;i<len;i++)moves.push(build_move(board,from,to,flags,pieces[i]))}var moves=[],us=turn,them=swap_color(us),second_rank={b:1,w:6},first_sq=SQUARES.a8,last_sq=SQUARES.h1,single_square=!1,legal=!(void 0!==options&&"legal"in options)||options.legal;if(void 0!==options&&"square"in options){if(!(options.square in SQUARES))return[];first_sq=last_sq=SQUARES[options.square],single_square=!0}for(var i=first_sq;i<=last_sq;i++)if(136&i)i+=7;else{var piece=board[i];if(null!=piece&&piece.color===us)if("p"===piece.type){var square=i+PAWN_OFFSETS[us][0];if(null==board[square]){add_move(board,moves,i,square,BITS.NORMAL);var square=i+PAWN_OFFSETS[us][1];second_rank[us]===rank(i)&&null==board[square]&&add_move(board,moves,i,square,BITS.BIG_PAWN)}for(j=2;j<4;j++){var square;136&(square=i+PAWN_OFFSETS[us][j])||(null!=board[square]&&board[square].color===them?add_move(board,moves,i,square,BITS.CAPTURE):square===ep_square&&add_move(board,moves,i,ep_square,BITS.EP_CAPTURE))}}else for(var j=0,len=PIECE_OFFSETS[piece.type].length;j<len;j++)for(var offset=PIECE_OFFSETS[piece.type][j],square=i;!(136&(square+=offset));){if(null!=board[square]){if(board[square].color===us)break;add_move(board,moves,i,square,BITS.CAPTURE);break}if(add_move(board,moves,i,square,BITS.NORMAL),"n"===piece.type||"k"===piece.type)break}}if(!single_square||last_sq===kings[us]){if(castling[us]&BITS.KSIDE_CASTLE){var castling_from,castling_to=(castling_from=kings[us])+2;null!=board[castling_from+1]||null!=board[castling_to]||attacked(them,kings[us])||attacked(them,castling_from+1)||attacked(them,castling_to)||add_move(board,moves,kings[us],castling_to,BITS.KSIDE_CASTLE)}if(castling[us]&BITS.QSIDE_CASTLE){var castling_from,castling_to=(castling_from=kings[us])-2;null!=board[castling_from-1]||null!=board[castling_from-2]||null!=board[castling_from-3]||attacked(them,kings[us])||attacked(them,castling_from-1)||attacked(them,castling_to)||add_move(board,moves,kings[us],castling_to,BITS.QSIDE_CASTLE)}}if(!legal)return moves;for(var legal_moves=[],i=0,len=moves.length;i<len;i++)make_move(moves[i]),king_attacked(us)||legal_moves.push(moves[i]),undo_move();return legal_moves}function move_to_san(move,sloppy){var output="";if(move.flags&BITS.KSIDE_CASTLE)output="O-O";else if(move.flags&BITS.QSIDE_CASTLE)output="O-O-O";else{var disambiguator=get_disambiguator(move,sloppy);"p"!==move.piece&&(output+=move.piece.toUpperCase()+disambiguator),move.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)&&("p"===move.piece&&(output+=algebraic(move.from)[0]),output+="x"),output+=algebraic(move.to),move.flags&BITS.PROMOTION&&(output+="="+move.promotion.toUpperCase())}return make_move(move),in_check()&&(in_checkmate()?output+="#":output+="+"),undo_move(),output}function stripped_san(move){return move.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function attacked(color,square){for(var i=SQUARES.a8;i<=SQUARES.h1;i++)if(136&i)i+=7;else if(null!=board[i]&&board[i].color===color){var piece=board[i],difference=i-square,index=difference+119;if(ATTACKS[index]&1<<SHIFTS[piece.type]){if("p"===piece.type){if(difference>0){if("w"===piece.color)return!0}else if("b"===piece.color)return!0;continue}if("n"===piece.type||"k"===piece.type)return!0;for(var offset=RAYS[index],j=i+offset,blocked=!1;j!==square;){if(null!=board[j]){blocked=!0;break}j+=offset}if(!blocked)return!0}}return!1}function king_attacked(color){return attacked(swap_color(color),kings[color])}function in_check(){return king_attacked(turn)}function in_checkmate(){return in_check()&&0===generate_moves().length}function in_stalemate(){return!in_check()&&0===generate_moves().length}function insufficient_material(){for(var pieces={},bishops=[],num_pieces=0,sq_color=0,i=SQUARES.a8;i<=SQUARES.h1;i++)if(sq_color=(sq_color+1)%2,136&i)i+=7;else{var piece=board[i];piece&&(pieces[piece.type]=piece.type in pieces?pieces[piece.type]+1:1,"b"===piece.type&&bishops.push(sq_color),num_pieces++)}if(2===num_pieces)return!0;if(3===num_pieces&&(1===pieces.b||1===pieces.n))return!0;if(num_pieces===pieces.b+2){for(var sum=0,len=bishops.length,i=0;i<len;i++)sum+=bishops[i];if(0===sum||sum===len)return!0}return!1}function in_threefold_repetition(){for(var moves=[],positions={},repetition=!1;;){var move=undo_move();if(!move)break;moves.push(move)}for(;;){var fen=generate_fen().split(" ").slice(0,4).join(" ");if(positions[fen]=fen in positions?positions[fen]+1:1,positions[fen]>=3&&(repetition=!0),!moves.length)break;make_move(moves.pop())}return repetition}function push(move){history.push({move:move,kings:{b:kings.b,w:kings.w},turn:turn,castling:{b:castling.b,w:castling.w},ep_square:ep_square,half_moves:half_moves,move_number:move_number})}function make_move(move){var us=turn,them=swap_color(us);if(push(move),board[move.to]=board[move.from],board[move.from]=null,move.flags&BITS.EP_CAPTURE&&("b"===turn?board[move.to-16]=null:board[move.to+16]=null),move.flags&BITS.PROMOTION&&(board[move.to]={type:move.promotion,color:us}),"k"===board[move.to].type){if(kings[board[move.to].color]=move.to,move.flags&BITS.KSIDE_CASTLE){var castling_to=move.to-1,castling_from=move.to+1;board[castling_to]=board[castling_from],board[castling_from]=null}else if(move.flags&BITS.QSIDE_CASTLE){var castling_to=move.to+1,castling_from=move.to-2;board[castling_to]=board[castling_from],board[castling_from]=null}castling[us]=""}if(castling[us])for(var i=0,len=ROOKS[us].length;i<len;i++)if(move.from===ROOKS[us][i].square&&castling[us]&ROOKS[us][i].flag){castling[us]^=ROOKS[us][i].flag;break}if(castling[them])for(var i=0,len=ROOKS[them].length;i<len;i++)if(move.to===ROOKS[them][i].square&&castling[them]&ROOKS[them][i].flag){castling[them]^=ROOKS[them][i].flag;break}ep_square=move.flags&BITS.BIG_PAWN?"b"===turn?move.to-16:move.to+16:-1,"p"===move.piece?half_moves=0:move.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)?half_moves=0:half_moves++,"b"===turn&&move_number++,turn=swap_color(turn)}function undo_move(){var old=history.pop();if(null==old)return null;var move=old.move;kings=old.kings,turn=old.turn,castling=old.castling,ep_square=old.ep_square,half_moves=old.half_moves,move_number=old.move_number;var us=turn,them=swap_color(turn),castling_to,castling_from;if(board[move.from]=board[move.to],board[move.from].type=move.piece,board[move.to]=null,move.flags&BITS.CAPTURE)board[move.to]={type:move.captured,color:them};else if(move.flags&BITS.EP_CAPTURE){var index;index="b"===us?move.to-16:move.to+16,board[index]={type:"p",color:them}}move.flags&(BITS.KSIDE_CASTLE|BITS.QSIDE_CASTLE)&&(move.flags&BITS.KSIDE_CASTLE?(castling_to=move.to+1,castling_from=move.to-1):move.flags&BITS.QSIDE_CASTLE&&(castling_to=move.to-2,castling_from=move.to+1),board[castling_to]=board[castling_from],board[castling_from]=null);return move}function get_disambiguator(move,sloppy){for(var moves=generate_moves({legal:!sloppy}),from=move.from,to=move.to,piece=move.piece,ambiguities=0,same_rank=0,same_file=0,i=0,len=moves.length;i<len;i++){var ambig_from=moves[i].from,ambig_to=moves[i].to,ambig_piece;piece===moves[i].piece&&from!==ambig_from&&to===ambig_to&&(ambiguities++,rank(from)===rank(ambig_from)&&same_rank++,file(from)===file(ambig_from)&&same_file++)}return ambiguities>0?same_rank>0&&same_file>0?algebraic(from):same_file>0?algebraic(from).charAt(1):algebraic(from).charAt(0):""}function ascii(){for(var s="   +------------------------+\n",i=SQUARES.a8;i<=SQUARES.h1;i++){if(0===file(i)&&(s+=" "+"87654321"[rank(i)]+" |"),null==board[i])s+=" . ";else{var piece=board[i].type,color,symbol;s+=" "+("w"===board[i].color?piece.toUpperCase():piece.toLowerCase())+" "}i+1&136&&(s+="|\n",i+=8)}return s+="   +------------------------+\n",s+="     a  b  c  d  e  f  g  h\n"}function move_from_san(move,sloppy){var clean_move=stripped_san(move);if(sloppy){var matches=clean_move.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(matches)var piece=matches[1],from=matches[2],to=matches[3],promotion=matches[4]}for(var moves=generate_moves(),i=0,len=moves.length;i<len;i++){if(clean_move===stripped_san(move_to_san(moves[i]))||sloppy&&clean_move===stripped_san(move_to_san(moves[i],!0)))return moves[i];if(matches&&(!piece||piece.toLowerCase()==moves[i].piece)&&SQUARES[from]==moves[i].from&&SQUARES[to]==moves[i].to&&(!promotion||promotion.toLowerCase()==moves[i].promotion))return moves[i]}return null}function rank(i){return i>>4}function file(i){return 15&i}function algebraic(i){var f=file(i),r=rank(i);return"abcdefgh".substring(f,f+1)+"87654321".substring(r,r+1)}function swap_color(c){return"w"===c?"b":"w"}function is_digit(c){return-1!=="0123456789".indexOf(c)}function make_pretty(ugly_move){var move=clone(ugly_move);move.san=move_to_san(move,!1),move.to=algebraic(move.to),move.from=algebraic(move.from);var flags="";for(var flag in BITS)BITS[flag]&move.flags&&(flags+=FLAGS[flag]);return move.flags=flags,move}function clone(obj){var dupe=obj instanceof Array?[]:{};for(var property in obj)dupe[property]="object"==typeof property?clone(obj[property]):obj[property];return dupe}function trim(str){return str.replace(/^\s+|\s+$/g,"")}function perft(depth){for(var moves=generate_moves({legal:!1}),nodes=0,color=turn,i=0,len=moves.length;i<len;i++){var child_nodes;if(make_move(moves[i]),!king_attacked(color))if(depth-1>0)nodes+=perft(depth-1);else nodes++;undo_move()}return nodes}return load(void 0===fen?DEFAULT_POSITION:fen),{WHITE:"w",BLACK:"b",PAWN:"p",KNIGHT:"n",BISHOP:"b",ROOK:"r",QUEEN:"q",KING:"k",SQUARES:function(){for(var keys=[],i=SQUARES.a8;i<=SQUARES.h1;i++)136&i?i+=7:keys.push(algebraic(i));return keys}(),FLAGS:FLAGS,load:function(fen){return load(fen)},reset:function(){return reset()},moves:function(options){for(var ugly_moves=generate_moves(options),moves=[],i=0,len=ugly_moves.length;i<len;i++)void 0!==options&&"verbose"in options&&options.verbose?moves.push(make_pretty(ugly_moves[i])):moves.push(move_to_san(ugly_moves[i],!1));return moves},in_check:function(){return in_check()},in_checkmate:function(){return in_checkmate()},in_stalemate:function(){return in_stalemate()},in_draw:function(){return half_moves>=100||in_stalemate()||insufficient_material()||in_threefold_repetition()},insufficient_material:function(){return insufficient_material()},in_threefold_repetition:function(){return in_threefold_repetition()},game_over:function(){return half_moves>=100||in_checkmate()||in_stalemate()||insufficient_material()||in_threefold_repetition()},validate_fen:function(fen){return validate_fen(fen)},fen:function(){return generate_fen()},board:function(){for(var output=[],row=[],i=SQUARES.a8;i<=SQUARES.h1;i++)null==board[i]?row.push(null):row.push({type:board[i].type,color:board[i].color}),i+1&136&&(output.push(row),row=[],i+=8);return output},pgn:function(options){var newline="object"==typeof options&&"string"==typeof options.newline_char?options.newline_char:"\n",max_width="object"==typeof options&&"number"==typeof options.max_width?options.max_width:0,result=[],header_exists=!1;for(var i in header)result.push("["+i+' "'+header[i]+'"]'+newline),header_exists=!0;header_exists&&history.length&&result.push(newline);for(var append_comment=function(move_string){var comment=comments[generate_fen()],delimiter;void 0!==comment&&(move_string=`${move_string}${move_string.length>0?" ":""}{${comment}}`);return move_string},reversed_history=[];history.length>0;)reversed_history.push(undo_move());var moves=[],move_string="";for(0===reversed_history.length&&moves.push(append_comment(""));reversed_history.length>0;){move_string=append_comment(move_string);var move=reversed_history.pop();history.length||"b"!==move.color?"w"===move.color&&(move_string.length&&moves.push(move_string),move_string=move_number+"."):move_string=move_number+". ...",move_string=move_string+" "+move_to_san(move,!1),make_move(move)}if(move_string.length&&moves.push(append_comment(move_string)),void 0!==header.Result&&moves.push(header.Result),0===max_width)return result.join("")+moves.join(" ");for(var strip=function(){return result.length>0&&" "===result[result.length-1]&&(result.pop(),!0)},wrap_comment=function(width,move){for(var token of move.split(" "))if(token){if(width+token.length>max_width){for(;strip();)width--;result.push(newline),width=0}result.push(token),width+=token.length,result.push(" "),width++}return strip()&&width--,width},current_width=0,i=0;i<moves.length;i++)current_width+moves[i].length>max_width&&moves[i].includes("{")?current_width=wrap_comment(current_width,moves[i]):(current_width+moves[i].length>max_width&&0!==i?(" "===result[result.length-1]&&result.pop(),result.push(newline),current_width=0):0!==i&&(result.push(" "),current_width++),result.push(moves[i]),current_width+=moves[i].length);return result.join("")},load_pgn:function(pgn,options){var sloppy=void 0!==options&&"sloppy"in options&&options.sloppy;function mask(str){return str.replace(/\\/g,"\\")}function has_keys(object){for(var key in object)return!0;return!1}function parse_pgn_header(header,options){for(var newline_char="object"==typeof options&&"string"==typeof options.newline_char?options.newline_char:"\r?\n",header_obj={},headers=header.split(new RegExp(mask(newline_char))),key="",value="",i=0;i<headers.length;i++)key=headers[i].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),value=headers[i].replace(/^\[[A-Za-z]+\s"(.*)"\ *\]$/,"$1"),trim(key).length>0&&(header_obj[key]=value);return header_obj}var newline_char="object"==typeof options&&"string"==typeof options.newline_char?options.newline_char:"\r?\n",header_regex=new RegExp("^(\\[((?:"+mask(newline_char)+")|.)*\\])(?:"+mask(newline_char)+"){2}"),header_string=header_regex.test(pgn)?header_regex.exec(pgn)[1]:"";reset();var headers=parse_pgn_header(header_string,options);for(var key in headers)set_header([key,headers[key]]);if("1"===headers.SetUp&&!("FEN"in headers&&load(headers.FEN,!0)))return!1;for(var to_hex=function(string){return Array.from(string).map((function(c){return c.charCodeAt(0)<128?c.charCodeAt(0).toString(16):encodeURIComponent(c).replace(/\%/g,"").toLowerCase()})).join("")},from_hex=function(string){return 0==string.length?"":decodeURIComponent("%"+string.match(/.{1,2}/g).join("%"))},encode_comment=function(string){return string=string.replace(new RegExp(mask(newline_char),"g")," "),`{${to_hex(string.slice(1,string.length-1))}}`},decode_comment=function(string){if(string.startsWith("{")&&string.endsWith("}"))return from_hex(string.slice(1,string.length-1))},ms=pgn.replace(header_string,"").replace(new RegExp(`({[^}]*})+?|;([^${mask(newline_char)}]*)`,"g"),(function(match,bracket,semicolon){return void 0!==bracket?encode_comment(bracket):" "+encode_comment(`{${semicolon.slice(1)}}`)})).replace(new RegExp(mask(newline_char),"g")," "),rav_regex=/(\([^\(\)]+\))+?/g;rav_regex.test(ms);)ms=ms.replace(rav_regex,"");var moves=trim(ms=(ms=(ms=ms.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));moves=moves.join(",").replace(/,,+/g,",").split(",");for(var move="",half_move=0;half_move<moves.length-1;half_move++){var comment=decode_comment(moves[half_move]);if(void 0===comment){if(null==(move=move_from_san(moves[half_move],sloppy)))return!1;make_move(move)}else comments[generate_fen()]=comment}if(void 0!==(comment=decode_comment(moves[moves.length-1]))&&(comments[generate_fen()]=comment,moves.pop()),move=moves[moves.length-1],POSSIBLE_RESULTS.indexOf(move)>-1)has_keys(header)&&void 0===header.Result&&set_header(["Result",move]);else{if(null==(move=move_from_san(move,sloppy)))return!1;make_move(move)}return!0},header:function(){return set_header(arguments)},ascii:function(){return ascii()},turn:function(){return turn},move:function(move,options){var sloppy=void 0!==options&&"sloppy"in options&&options.sloppy,move_obj=null;if("string"==typeof move)move_obj=move_from_san(move,sloppy);else if("object"==typeof move)for(var moves=generate_moves(),i=0,len=moves.length;i<len;i++)if(!(move.from!==algebraic(moves[i].from)||move.to!==algebraic(moves[i].to)||"promotion"in moves[i]&&move.promotion!==moves[i].promotion)){move_obj=moves[i];break}if(!move_obj)return null;var pretty_move=make_pretty(move_obj);return make_move(move_obj),pretty_move},undo:function(){var move=undo_move();return move?make_pretty(move):null},clear:function(){return clear()},put:function(piece,square){return put(piece,square)},get:function(square){return get(square)},remove:function(square){return remove(square)},perft:function(depth){return perft(depth)},square_color:function(square){if(square in SQUARES){var sq_0x88=SQUARES[square];return(rank(sq_0x88)+file(sq_0x88))%2==0?"light":"dark"}return null},history:function(options){for(var reversed_history=[],move_history=[],verbose=(void 0!==options&&"verbose"in options&&options.verbose);history.length>0;)reversed_history.push(undo_move());for(;reversed_history.length>0;){var move=reversed_history.pop();verbose?move_history.push(make_pretty(move)):move_history.push(move_to_san(move)),make_move(move)}return move_history},get_comment:function(){return comments[generate_fen()]},set_comment:function(comment){comments[generate_fen()]=comment.replace("{","[").replace("}","]")},delete_comment:function(){var comment=comments[generate_fen()];return delete comments[generate_fen()],comment},get_comments:function(){return prune_comments(),Object.keys(comments).map((function(fen){return{fen:fen,comment:comments[fen]}}))},delete_comments:function(){return prune_comments(),Object.keys(comments).map((function(fen){var comment=comments[fen];return delete comments[fen],{fen:fen,comment:comment}}))}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define((function(){return Chess}));