var _chessJS=new Chess;const _stockfish=STOCKFISH();var _stockfishIsReady=!1,_stockfishEnabled=-1;_stockfish.onmessage=function(event){stockfishReceiveData(event.data?event.data:event)};var _currentBoardState=null,_currentSquareSelected="",_currentSquareSelectedMoves=null,_boardDiv=null,_boardStateHistory=null,_boardStateHistoryLoadedGame=null,_boardOrientation=0,_boardDraggingPieceDiv=null,_boardInAnimation=!1,_currentPuzzle=null,_stockfishMessageDiv=null,_stockfishLinesSelect=null,_stockfishLines=[],_stockfishTimeout=null,_moveClockSecondTimers=[1e3,1e3],_moveClockMillisecondIntervals=[setInterval(clockMillisecondIntervalTick,10,0),setInterval(clockMillisecondIntervalTick,10,1)],_rightMouseDragPoints=null,_boardHighlights=[],_boardCanvasArrows=[],_boardCanvasCircles=[],_boardCanvasSquares=[],_boardCanvasDrawColor="rgba(255,0,0,0.75)",_boardThemes=[{name:"Blue",light:"rgb(234, 240, 215)",dark:"rgb(73, 101, 147)",backgroundImage:"",labelLight:"rgb(234, 240, 215)",labelDark:"rgb(73, 101, 147)"},{name:"Brown",light:"rgb(240, 219, 174)",dark:"rgb(193, 136, 93)",backgroundImage:"",labelLight:"rgb(240, 219, 174)",labelDark:"rgb(193, 136, 93)"},{name:"Green",light:"rgb(234, 244, 209)",dark:"rgb(99, 166, 83)",backgroundImage:"",labelLight:"rgb(234, 244, 209)",labelDark:"rgb(99, 166, 83)"},{name:"Ice",light:"rgba(236, 257, 241, 0.55)",dark:"rgba(102, 130, 159, 0.55)",backgroundImage:"assets/images/background-ice-0.png",labelLight:"rgb(236, 257, 241)",labelDark:"rgb(102, 130, 159)"},{name:"Stone",light:"rgba(188, 179, 165, 0.60)",dark:"rgba(38, 36, 39, 0.60)",backgroundImage:"assets/images/background-stone-0.png",labelLight:"rgb(208, 199, 185)",labelDark:"rgb(98, 96, 99)"},{name:"Tournament",light:"rgba(236, 239, 234, 0.4)",dark:"rgba(0, 113, 79, 0.75)",backgroundImage:"assets/images/background-vinyl-0.png",labelLight:"rgb(236, 239, 234)",labelDark:"rgb(0, 113, 79)"},{name:"Wood",light:"rgba(188, 159, 115, 0.45)",dark:"rgba(80, 46, 20, 0.55)",backgroundImage:"assets/images/background-wood-0.png",labelLight:"rgb(198, 169, 125)",labelDark:"rgb(130, 96, 70)"}],_boardTheme=_boardThemes[1],_piecesets=[{name:"Begebies",path:"assets/images/begebies-",extension:"svg",shadowColor:"rgba(20,20,20,0.45)",shadowBlur:3,shadowOffsetX:3,shadowOffsetY:3},{name:"CBurnett",path:"assets/images/cburnett-",extension:"png",shadowColor:"rgba(0,0,0,0)",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},{name:"CBurnett Alt.",path:"assets/images/cburnettalt-",extension:"png",shadowColor:"rgba(0,0,0,0)",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},{name:"Maestro",path:"assets/images/maestro-",extension:"png",shadowColor:"rgba(20,20,20,0.45)",shadowBlur:3,shadowOffsetX:3,shadowOffsetY:3}],_pieceset=_piecesets[0],_controlsVisible=!0,_inFullscreen=!1,_sounds=[new Audio("assets/sounds/move-0.wav"),new Audio("assets/sounds/capture-0.wav"),new Audio("assets/sounds/castle-0.wav")];class BoardState{constructor(fen){if(this.squares=[],this.fen=fen,null!=fen&&0!=fen.length){var fenParts=fen.split(" ");if(6==fenParts.length){for(var i=0;i<6;i++)if(0==i){var boardLayoutParts=fenParts[0].split("/");if(8!=boardLayoutParts.length)return void alert(`FEN string "${fen}" is invalid:\nNumber of ranks in board layout is incorrect.`);for(var rank=0;rank<8;rank++)for(var rankValue=boardLayoutParts[rank],file=0,j=0;j<rankValue.length;j++){var chr=rankValue[j];if(chr>=1&&chr<=8){var chrInt=parseInt(chr);if(file+chrInt>8)return void alert(`FEN string "${fen}" is invalid:\nRank '${rankValue}' in board layout is invalid.`);for(var k=0;k<chrInt;k++)this.squares.push("")}else{var chrLower=chr.toLowerCase();if("p"!=chrLower&&"n"!=chrLower&&"b"!=chrLower&&"r"!=chrLower&&"q"!=chrLower&&"k"!=chrLower)return void alert(`FEN string "${fen}" is invalid:\nCharacter '${chr}' in board layout rank ${8-rank} is invalid.`);this.squares.push(chr)}}}}else alert(`FEN string "${fen}" is invalid:\nNumber of parts is incorrect.`)}else{for(var board=_chessJS.board(),index=0,rank=0;rank<8;rank++)for(var file=0;file<8;file++){var value=board[rank][file];this.squares[index]=null==value?"":"w"==value.color?value.type.toUpperCase():value.type,index++}this.fen=_chessJS.fen()}}}class BoardStateHistory{constructor(){this.atIndex=0,this.comments=[],this.moves=[],this.states=[],this.startingFEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}add(move,boardState,comment,popRemaining){if(this.atIndex==this.moves.length)this.comments.push(comment),this.moves.push(move),this.states.push(boardState);else if(this.comments[this.atIndex]=comment,this.moves[this.atIndex]=move,this.states[this.atIndex]=boardState,popRemaining)for(;this.moves.length>this.atIndex+1;)this.moves.pop(),this.states.pop();this.atIndex++}clear(){for(this.atIndex=0;this.moves.length>0;)this.moves.pop(),this.states.pop();this.startingFEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}}class Vector{constructor(x,y){this.x=x,this.y=y}add(other){this.x+=other.x,this.y+=other.y}subtract(other){this.x-=other.x,this.y-=other.y}scaleBy(value){this.x*=value,this.y*=value}length(){return Math.hypot(this.x,this.y)}normalize(){this.scaleBy(1/this.length())}rotate(degrees){var radians=degrees*(Math.PI/180),cos=Math.cos(radians),sin=Math.sin(radians);this.x=Math.round(1e4*(this.x*cos-this.y*sin))/1e4,this.y=Math.round(1e4*(this.x*sin+this.y*cos))/1e4}}function animateMove(move,completedFunction){var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8;function animateMoveSub(color,piece,fromNotation,toNotation,callCompletedFunction){_boardInAnimation=!0;var from=getBoardSquarePositionForPositionNotation(fromNotation),to=getBoardSquarePositionForPositionNotation(toNotation);document.getElementById(`board-square-td-img_${fromNotation}`).src="assets/images/empty-0.png";var image=new Image;image.id="animating-piece-0-img",image.style.filter=`drop-shadow(${_pieceset.shadowOffsetX}px ${_pieceset.shadowOffsetY}px ${_pieceset.shadowBlur}px ${_pieceset.shadowColor})`,image.style.position="absolute",image.src=getImageSourceForColorAndPiece({color:color,piece:piece}),image.width=boardDivSquareSize,image.height=boardDivSquareSize,_boardDiv.appendChild(image),image.style.left=from.x+"px",image.style.top=from.y+"px";var imagePosition=new Vector(from.x,from.y),moveVector=new Vector(to.x,to.y);moveVector.subtract(new Vector(from.x,from.y)),moveVector.normalize(),moveVector.scaleBy(positionDistance(from,to)/20);var moveInterval=setInterval(()=>{imagePosition.x!=to.x||imagePosition.y!=to.y?(imagePosition.x+=moveVector.x,imagePosition.y+=moveVector.y,image.style.left=imagePosition.x+"px",image.style.top=imagePosition.y+"px",positionDistance(imagePosition,to)<10&&(imagePosition=new Vector(to.x,to.y))):(clearInterval(moveInterval),_boardDiv.removeChild(image),delete image,_boardInAnimation=!1,callCompletedFunction&&completedFunction())},10)}if("O-O"==move.san||"O-O-O"==move.san){var fromNotation="",toNotation="";"w"==move.color?"O-O"==move.san?(fromNotation="h1",toNotation="f1"):(fromNotation="a1",toNotation="d1"):"O-O"==move.san?(fromNotation="h8",toNotation="f8"):(fromNotation="a8",toNotation="d8"),animateMoveSub(move.color,"r",fromNotation,toNotation,!1)}animateMoveSub(move.color,move.piece,move.from,move.to,!0)}function boardCanvasClear(){_boardCanvasArrows=[],_boardCanvasCircles=[],_boardCanvasSquares=[];var canvas=document.getElementById("board-canvas-1"),context=canvas.getContext("2d");context.clearRect(0,0,canvas.width,canvas.height),(context=(canvas=document.getElementById("board-canvas-2")).getContext("2d")).clearRect(0,0,canvas.width,canvas.height)}function boardCanvasDrawArrow(from,to){for(var i=0;i<_boardCanvasArrows.length;i++){var arrow=_boardCanvasArrows[i];if(arrow.from.x==from.x&&arrow.from.y==from.y&&arrow.to.x==to.x&&arrow.to.y==to.y)return}_boardCanvasArrows.push({from:from,to:to});var canvas,context=document.getElementById("board-canvas-2").getContext("2d"),size=30;context.fillStyle=_boardCanvasDrawColor,context.strokeStyle=_boardCanvasDrawColor,context.lineWidth=30,context.lineCap="butt",context.lineJoin="bevel",context.shadowColor="rgba(150, 150, 150, 0.4)",context.shadowBlur=3;var angle=Math.atan2(to.y-from.y,to.x-from.x),hyp=Math.sqrt((to.x-from.x)*(to.x-from.x)+(to.y-from.y)*(to.y-from.y));context.save(),context.translate(from.x,from.y),context.rotate(angle),context.beginPath(),context.moveTo(0,0),context.lineTo(hyp-30,0),context.stroke(),context.beginPath(),context.lineTo(hyp-30,30),context.lineTo(hyp,0),context.lineTo(hyp-30,-30),context.fill(),context.restore()}function boardCanvasDrawArrowComplex(points){if(!(points.length<=1))if(2!=points.length){var canvas,context=document.getElementById("board-canvas-2").getContext("2d"),size=30,from=null,to=null,angle=0,hyp=0;context.fillStyle=_boardCanvasDrawColor,context.strokeStyle=_boardCanvasDrawColor,context.lineWidth=30,context.lineCap="butt",context.lineJoin="miter",context.shadowColor="rgba(150, 150, 150, 0.4)",context.shadowBlur=3,context.beginPath(),context.moveTo(points[0].x,points[0].y);for(var i=0;i<points.length-1;i++)if(from=points[i],to=points[i+1],_boardCanvasArrows.push({from:from,to:to}),i<points.length-2)context.lineTo(to.x,to.y);else{var v1=new Vector(from.x,from.y),v2=new Vector(to.x,to.y);v1.subtract(v2),v1.normalize(),v1.scaleBy(30),v2.add(v1),context.lineTo(v2.x,v2.y)}context.stroke(),from=points[points.length-2],to=points[points.length-1],angle=Math.atan2(to.y-from.y,to.x-from.x),hyp=Math.sqrt((to.x-from.x)*(to.x-from.x)+(to.y-from.y)*(to.y-from.y)),context.save(),context.translate(from.x,from.y),context.rotate(angle),context.beginPath(),context.lineTo(hyp-30,30),context.lineTo(hyp,0),context.lineTo(hyp-30,-30),context.fill(),context.restore()}else boardCanvasDrawArrow(points[0],points[1])}function boardCanvasDrawSquare(atCenter){for(var i=0;i<_boardCanvasSquares.length;i++){var square=_boardCanvasSquares[i];if(square.atCenter.x==atCenter.x&&square.atCenter.y==atCenter.y)return}_boardCanvasSquares.push({atCenter:atCenter});var canvas,context=document.getElementById("board-canvas-1").getContext("2d"),boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8;context.fillStyle=_boardCanvasDrawColor,context.strokeStyle=_boardCanvasDrawColor,context.shadowColor="rgba(150, 150, 150, 0.4)",context.shadowBlur=3,context.moveTo(0,0),context.beginPath(),context.lineTo(atCenter.x-boardDivSquareSize/2,atCenter.y-boardDivSquareSize/2),context.lineTo(atCenter.x+boardDivSquareSize/2,atCenter.y-boardDivSquareSize/2),context.lineTo(atCenter.x+boardDivSquareSize/2,atCenter.y+boardDivSquareSize/2),context.lineTo(atCenter.x-boardDivSquareSize/2,atCenter.y+boardDivSquareSize/2),context.fill()}function boardCanvasDrawCircle(atCenter){for(var i=0;i<_boardCanvasCircles.length;i++){var circle=_boardCanvasCircles[i];if(circle.atCenter.x==atCenter.x&&circle.atCenter.y==atCenter.y)return}_boardCanvasCircles.push({atCenter:atCenter});var canvas,context=document.getElementById("board-canvas-1").getContext("2d"),boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8;context.strokeStyle=_boardCanvasDrawColor,context.shadowColor="rgba(150, 150, 150, 0.4)",context.shadowBlur=3;for(var i=boardDivSquareSize/2;i>=boardDivSquareSize/2-5;i--)context.beginPath(),context.arc(atCenter.x,atCenter.y,i,0,2*Math.PI),context.stroke()}function boardSquareSelected(positionNotation,mouseEventType){var rank,file,index=8*(8-parseInt(positionNotation[1]))+(positionNotation.charCodeAt(0)-"a".charCodeAt(0)),squareValue=_currentBoardState.squares[index];if(""!=_currentSquareSelected){_boardDraggingPieceDiv.innerHTML="";for(var images=_boardDiv.getElementsByTagName("img"),i=0;i<images.length;i++)images[i].style.cursor="grabbing";for(var i=0;i<_currentSquareSelectedMoves.length;i++){var move=_currentSquareSelectedMoves[i];if(move.to==positionNotation)return void makeMoveFromCurrentBoardState(move,!1)}var colorAndPiece,imageSrc=getImageSourceForColorAndPiece(colorAndPiece=getColorAndPieceForPositionNotation(_currentSquareSelected));document.getElementById(`board-square-td-img_${_currentSquareSelected}`).src=imageSrc}if(""!=squareValue)if("down"==mouseEventType){if("w"==_chessJS.turn()&&squareValue.toLowerCase()!=squareValue||"b"==_chessJS.turn()&&squareValue.toLowerCase()==squareValue){_currentSquareSelected=positionNotation,_currentSquareSelectedMoves=_chessJS.moves({square:positionNotation,verbose:!0});var rankAndFile=getRankAndFileForPositionNotation(positionNotation),colorAndPiece,imageSrc=getImageSourceForColorAndPiece(colorAndPiece=getColorAndPieceForPositionNotation(positionNotation)),boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8;document.getElementById(`board-square-td-img_${positionNotation}`).src="assets/images/empty-0.png",_boardDraggingPieceDiv.innerHTML=`<img src="${imageSrc}" width="${boardDivSquareSize}" height="${boardDivSquareSize}" style="filter: drop-shadow(${_pieceset.shadowOffsetX}px ${_pieceset.shadowOffsetY}px ${_pieceset.shadowBlur}px ${_pieceset.shadowColor})" />`;var left=0==_boardOrientation?rankAndFile.file*boardDivSquareSize:(7-rankAndFile.file)*boardDivSquareSize,top=0==_boardOrientation?rankAndFile.rank*boardDivSquareSize:(7-rankAndFile.rank)*boardDivSquareSize;_boardDraggingPieceDiv.style.left=left+"px",_boardDraggingPieceDiv.style.top=top+"px",_boardDraggingPieceDiv.style.width=boardDivSquareSize+"px",_boardDraggingPieceDiv.style.height=boardDivSquareSize+"px";for(var images=_boardDiv.getElementsByTagName("img"),i=0;i<images.length;i++)images[i].style.cursor="grabbing"}}else _currentSquareSelected==positionNotation&&(document.getElementById(`board-square-td-img_${positionNotation}`).src=getImageSourceForColorAndPiece(getColorAndPieceForPositionNotation(positionNotation))),_currentSquareSelected="",_currentSquareSelectedMoves=null}function buildBoardSquaresTable(){for(var boardSquaresTable=document.getElementById("board-squares-table"),boardSquareSize=.95*document.getElementById("content").offsetHeight/8,innerHTML="",bgColorIndex=0,rank=0;rank<8;rank++){innerHTML+="<tr>";for(var file=0;file<8;file++){var bgColor=bgColorIndex%2==0?"rgb(240, 219, 174)":"rgb(193, 136, 93)",positionNotation=getPositionNotationForRankAndFile(rank,file),displayRank,displayFile=7==rank?"block":"none";innerHTML+=`<td id="board-square-td_${positionNotation}" style="width: ${boardSquareSize}; height: ${boardSquareSize}; background-color: ${bgColor}">`,innerHTML+=`<span id="board-square-td-span_${positionNotation}-rank" class="board-square-td-span" style="display: ${0==file?"block":"none"}; margin-left: ${boardSquareSize/12}px; margin-top: ${boardSquareSize/15}px;">${positionNotation[1]}</span>`,innerHTML+=`<span id="board-square-td-span_${positionNotation}-file" class="board-square-td-span" style="display: ${displayFile}; margin-left: ${boardSquareSize-boardSquareSize/4.2}px; margin-top: ${boardSquareSize-boardSquareSize/3}px;">${positionNotation[0]}</span>`,innerHTML+=`<img id="board-square-td-img_${positionNotation}" class="board-square-td-img" src="assets/images/empty-0.png" width="${boardSquareSize}" height="${boardSquareSize}" onmousedown="boardSquare_onMouseDown(event, '${positionNotation}')" onmouseup="boardSquare_onMouseUp(event, '${positionNotation}')" />`,innerHTML+="</td>",bgColorIndex++}innerHTML+="</tr>",bgColorIndex++}boardSquaresTable.innerHTML=innerHTML;var boardCanvas=document.getElementById("board-canvas-1");boardCanvas.width=8*boardSquareSize,boardCanvas.height=8*boardSquareSize,boardCanvas.style.width=8*boardSquareSize,boardCanvas.style.height=8*boardSquareSize,(boardCanvas=document.getElementById("board-canvas-2")).width=8*boardSquareSize,boardCanvas.height=8*boardSquareSize,boardCanvas.style.width=8*boardSquareSize,boardCanvas.style.height=8*boardSquareSize}function clearBoardHighlights(){_boardHighlights=[],updateBoardFromBoardState(_currentBoardState)}function clockMillisecondIntervalTick(turn){var select;if(0!=document.getElementById("controls-time-select").selectedIndex&&("w"==_chessJS.turn()&&0==turn||"b"==_chessJS.turn()&&1==turn)&&(_moveClockSecondTimers[turn]-=10,!(_moveClockSecondTimers[turn]>0))){_moveClockSecondTimers[turn]+=1e3;var span1=0==turn?document.getElementById("controls-time-white-span"):document.getElementById("controls-time-black-span"),span2=0==turn?document.getElementById("side-time-white-span"):document.getElementById("side-time-black-span"),textContentParts=span1.textContent.split(":"),minutes=parseInt(textContentParts[0]),seconds=parseInt(textContentParts[1]);0==minutes&&0==seconds||(--seconds<0&&(minutes--,seconds=59),span1.textContent=`${minutes}:${seconds}`,span2.textContent=`${minutes}:${seconds}`)}}function getBoardSquareCenterPosition(moveEventClientPosition){var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize=boardDivRect.right-boardDivRect.left,boardDivSquareSize=boardDivSize/8,x=0,y=0;return 0==_boardOrientation?(x=Math.floor((moveEventClientPosition.x-boardDivRect.left)/boardDivSize*8)*boardDivSquareSize+boardDivSquareSize/2,y=Math.floor((moveEventClientPosition.y-boardDivRect.top)/boardDivSize*8)*boardDivSquareSize+boardDivSquareSize/2):(x=Math.floor((boardDivSize-(moveEventClientPosition.x-boardDivRect.left))/boardDivSize*8)*boardDivSquareSize+boardDivSquareSize/2,y=Math.floor((boardDivSize-(moveEventClientPosition.y-boardDivRect.top))/boardDivSize*8)*boardDivSquareSize+boardDivSquareSize/2),{x:x,y:y}}function getBoardSquarePositionForPositionNotation(notation){var rankFile=getRankAndFileForPositionNotation(notation),boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8;return 0==_boardOrientation?{x:rankFile.file*boardDivSquareSize,y:rankFile.rank*boardDivSquareSize}:{x:(7-rankFile.file)*boardDivSquareSize,y:(7-rankFile.rank)*boardDivSquareSize}}function getColorAndPieceForPositionNotation(notation){var rankAndFile=getRankAndFileForPositionNotation(notation),value=_currentBoardState.squares[8*rankAndFile.rank+rankAndFile.file],color="",piece="";return""!=value&&(piece=value.toLowerCase(),color=value==value.toLowerCase()?"b":"w"),{color:color,piece:piece}}function getImageSourceForColorAndPiece(colorAndPiece){var piece=colorAndPiece.piece.toLowerCase(),src="";return"p"==piece&&(src+=`${_pieceset.path}pawn-`),"n"==piece&&(src+=`${_pieceset.path}knight-`),"b"==piece&&(src+=`${_pieceset.path}bishop-`),"r"==piece&&(src+=`${_pieceset.path}rook-`),"q"==piece&&(src+=`${_pieceset.path}queen-`),"k"==piece&&(src+=`${_pieceset.path}king-`),src+="w"==colorAndPiece.color?"0":"1",src+=`.${_pieceset.extension}`}function getMoveForNotation(notation,chessJSObject){if(4!=notation.length)return null;null==chessJSObject&&(chessJSObject=_chessJS);for(var moves=chessJSObject.moves({verbose:!0}),from=notation.substring(0,2),to=notation.substring(2),i=0;i<moves.length;i++){var move=moves[i];if(move.san==notation)return move;if(move.from==from&&move.to==to)return move}return null}function getPositionForBoardDraggingPieceDivFromMouseEvent(mouseEvent){var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8,left,top;return{x:_controlsVisible?mouseEvent.clientX-(boardDivSquareSize/2+boardDivRect.left):mouseEvent.clientX-(boardDivRect.left+boardDivSquareSize/2),y:mouseEvent.clientY-boardDivSquareSize+boardDivRect.top}}function getPositionNotationForBoardSquareValue(value){for(var squareIndex=0,rank=0;rank<8;rank++)for(var file=0;file<8;file++){var squareValue=_currentBoardState.squares[squareIndex],positionNotation=getPositionNotationForRankAndFile(rank,file);if(squareValue==value)return positionNotation;squareIndex++}return""}function getPositionNotationForRealBoardPosition(position){for(var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSquareSize=(boardDivRect.right-boardDivRect.left)/8,rank=0;rank<9;rank++)for(var file=0;file<9;file++)if(position.x<file*boardDivSquareSize&&position.y<rank*boardDivSquareSize)return getPositionNotationForRankAndFile(rank-1,file-1);return""}function getPositionNotationForRankAndFile(rank,file){var fileLetters;return["a","b","c","d","e","f","g","h"][file]+(8-rank)}function getRankAndFileForPositionNotation(notation){for(var fileLetters=["a","b","c","d","e","f","g","h"],rank=8-parseInt(notation[1]),file=0,i=0;i<8;i++)if(notation[0]==fileLetters[i]){file=i;break}return{rank:rank,file:file}}function loadGame(){var element=document.getElementById("loadGameInput"),files=element.files;if(0!=files.length){var fileReader=new FileReader;fileReader.onload=e=>{reset();var fileContent=e.target.result;element.value=null,_chessJS.load_pgn(fileContent),_boardStateHistory.clear(),_boardStateHistoryLoadedGame=new BoardStateHistory,chessJSAlt=new Chess,chessJSAlt.load("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");for(var history=_chessJS.history({verbose:!0}),i=0;i<history.length;i++){var move=history[i];chessJSAlt.move(move.san);for(var fen=chessJSAlt.fen(),boardState=new BoardState(fen),comments=_chessJS.get_comments(),comment="",j=0;j<comments.length;j++)if(comments[j].fen==fen){comment=comments[j].comment;break}_boardStateHistory.add(move,boardState,comment,!1),_boardStateHistoryLoadedGame.add(move,boardState,comment,!1)}updateBoardFromBoardState(_currentBoardState=new BoardState(chessJSAlt.fen)),updateControlsFENInput(),updateControlsMovesTable(),updateGameDetailsMoveCommentTextArea(),updateControlsOpeningDiv();for(var pgn=_chessJS.pgn(),pgnLines=(pgn=pgn.replaceAll("[","").replaceAll("]","")).split("\n"),i=0;i<pgnLines.length;i++){var pgnLine=pgnLines[i].trim();if(0==pgnLine.length)break;var pgnLineParts=pgnLine.split('"'),key=pgnLineParts[0].trim().toLowerCase(),value=pgnLineParts[1].trim(),input=document.getElementById(`controls-game-details-${key}-input`);null!=input&&(input.value=value)}document.getElementById("controls-game-button-first-move").disabled=!1,document.getElementById("controls-game-button-previous-move").disabled=!1,document.getElementById("controls-game-button-next-move").disabled=!1,document.getElementById("controls-game-button-last-move").disabled=!1,document.getElementById("controls-game-button-save").disabled=!1,document.getElementById("controls-game-button-reset").disabled=!1},fileReader.onerror=e=>alert(`Could not load file "${e.target.error.name}".`),fileReader.readAsText(files[0])}}function makeMoveFromCurrentBoardState(move,animate){function completedActions(){_chessJS.move(move.san),setCurrentBoardStateToChessJSBoard(),_currentSquareSelected="";var popRemaining=!0;if(null!=_boardStateHistoryLoadedGame){var moveOther=_boardStateHistoryLoadedGame.moves[_boardStateHistory.atIndex];null!=moveOther&&move.san==moveOther.san&&(popRemaining=!1)}if(_boardStateHistory.add(move,_currentBoardState,_chessJS.get_comment(),popRemaining),playSoundForMove(move),_stockfishEnabled>-1&&!_chessJS.in_checkmate()&&stockfishUpdate(move),_chessJS.in_check()||_chessJS.in_checkmate()){var value="w"==_chessJS.turn()?"K":"k",highlight=_chessJS.in_checkmate()?"checkmate":"check";setBoardHighlight(getPositionNotationForBoardSquareValue(value),highlight)}updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateControlsOpeningDiv(),document.getElementById("controls-game-button-first-move").disabled=!1,document.getElementById("controls-game-button-previous-move").disabled=!1,document.getElementById("controls-game-button-next-move").disabled=!1,document.getElementById("controls-game-button-last-move").disabled=!1,document.getElementById("controls-game-button-save").disabled=!1}clearBoardHighlights(),setBoardHighlight(move.from,"from"),setBoardHighlight(move.to,"to"),animate?animateMove(move,completedActions):completedActions()}function makeMoveFromCurrentBoardStateFromTo(moveAsFromTo){var move=getMoveForNotation(moveAsFromTo);null!=move&&makeMoveFromCurrentBoardState(move,!0)}function playSoundForMove(move){move.san.includes("x")?_sounds[1].play():"O-O"==move.san||"O-O-O"==move.san?_sounds[2].play():_sounds[0].play()}function pointArrayContains(pointArray,point){for(var i=0;i<pointArray.length;i++)if(pointArray[i].x==point.x&&pointArray[i].y==point.y)return!0;return!1}function positionControlsDiv(){for(var content=document.getElementById("content"),controlsDiv=document.getElementById("controls-div"),left=_boardDiv.offsetLeft+_boardDiv.offsetWidth+25;left+controlsDiv.offsetWidth>content.offsetWidth;)left--;controlsDiv.style.left=left+"px"}function positionDistance(from,to){var xs=to.x-from.x,ys=to.y-from.y;return xs*=xs,ys*=ys,Math.sqrt(xs+ys)}function reset(){_chessJS.reset(),setCurrentBoardStateToChessJSBoard(),_boardStateHistory.clear(),_boardStateHistoryLoadedGame=null,_currentSquareSelected="",_currentPuzzle=null,null!=_stockfishTimeout&&clearTimeout(_stockfishTimeout),clearBoardHighlights(),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateGameDetailsMoveCommentTextArea(),updateControlsOpeningDiv(),updateControlsPuzzleDiv(),boardCanvasClear(),resetMoveClocks(),_stockfishEnabled>-1&&stockfishUpdate();for(var gameDetailsFields=["white","black","event","site","date","eventdate","result"],i=0;i<gameDetailsFields.length;i++){var input=document.getElementById(`controls-game-details-${gameDetailsFields[i]}-input`);null!=input&&(input.value="")}document.getElementById("controls-game-button-first-move").disabled=!0,document.getElementById("controls-game-button-previous-move").disabled=!0,document.getElementById("controls-game-button-next-move").disabled=!0,document.getElementById("controls-game-button-last-move").disabled=!0,document.getElementById("controls-game-button-save").disabled=!0,document.getElementById("controls-game-button-reset").disabled=!0,document.getElementById("controls-reset-puzzle-button").disabled=!0}function resetCurrentPuzzle(){null!=_currentPuzzle&&(_chessJS.reset(),setCurrentBoardStateToChessJSBoard(),_currentSquareSelected="",_boardStateHistory.clear(),setCurrentBoardStateToFEN(_currentPuzzle.FEN),_currentPuzzle.instructions.toLowerCase().includes("black")&&_boardStateHistory.add(null,null,"",!1),boardCanvasClear(),resetMoveClocks(),clearBoardHighlights(),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateGameDetailsMoveCommentTextArea(),_stockfishEnabled>-1&&stockfishUpdate(),document.getElementById("controls-reset-puzzle-button").disabled=!1)}function resetLoadedGame(){if(null!=_boardStateHistoryLoadedGame){var atIndex=_boardStateHistory.atIndex;atIndex>_boardStateHistoryLoadedGame.moves.length&&(atIndex=_boardStateHistoryLoadedGame.moves.length-1);for(var divergenceAt=-1,i=0;i<Math.max(_boardStateHistory.moves.length,_boardStateHistoryLoadedGame.moves.length);i++){for(var j=i;j<i+2;j++){var moveBSH=_boardStateHistory.moves[j],moveBSHLG=_boardStateHistoryLoadedGame.moves[j];if(null!=moveBSH&&null!=moveBSHLG&&moveBSH.san!=moveBSHLG.san){divergenceAt=j;break}}if(i++,-1!=divergenceAt)break}atIndex=-1!=divergenceAt?divergenceAt:0,_boardStateHistory.clear();for(var i=0;i<_boardStateHistoryLoadedGame.moves.length;i++)_boardStateHistory.add(_boardStateHistoryLoadedGame.moves[i],_boardStateHistoryLoadedGame.states[i],_boardStateHistoryLoadedGame.comments[i],!1);setCurrentBoardStateByMoveIndex(atIndex-1)}}function resetMoveClocks(){var select=document.getElementById("controls-time-select"),timeSpans=[document.getElementById("controls-time-white-span"),document.getElementById("controls-time-black-span"),document.getElementById("side-time-white-span"),document.getElementById("side-time-black-span")],time=0;1==select.selectedIndex&&(time=90),2==select.selectedIndex&&(time=10),3==select.selectedIndex&&(time=5),4==select.selectedIndex&&(time=3),_moveClockSecondTimers=[1e3,1e3];for(var i=0;i<4;i++)timeSpans[i].textContent=`${time}:00`}function saveBoardAsImage(){function getScreenshotOfElement(element,position,width,height,callback){html2canvas(element,{width:width,height:height}).then((function(canvas){var context,imageData=canvas.getContext("2d").getImageData(position.x,position.y,width,height).data,outputCanvas=document.createElement("canvas"),outputContext=outputCanvas.getContext("2d");outputCanvas.width=width,outputCanvas.height=height;var idata=outputContext.createImageData(width,height);idata.data.set(imageData),outputContext.putImageData(idata,0,0),callback(outputCanvas.toDataURL())}))}var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize,boardDivSizeFactor=1.25*(boardDivRect.right-boardDivRect.left);getScreenshotOfElement(_boardDiv,{x:0,y:0},boardDivSizeFactor,boardDivSizeFactor,data=>{var link=document.createElement("a");link.setAttribute("href",data),link.setAttribute("download","board.png"),document.body.appendChild(link),link.click(),document.body.removeChild(link),delete link})}function saveGame(){for(var content="",result="?",date=new Date,headers=["White","Black","Event","Site","Date","EventDate","Result","ECO"],i=0;i<headers.length;i++){var input=document.getElementById(`controls-game-details-${headers[i].toLowerCase()}-input`);if(null!=input){var inputValue=input.value.trim();if(0==inputValue.length&&(inputValue="?","Date"==headers[i]&&(inputValue=`${date.getFullYear()}.${date.getMonth()}.${date.getDate()}`),"EventDate"==headers[i]&&(inputValue=`${date.getFullYear()}.${date.getMonth()}.${date.getDate()}`),"Result"==headers[i]&&_chessJS.in_checkmate()&&(inputValue=result="w"==_chessJS.turn()?"1-0":"0-1"),"ECO"==headers[i])){var opening=getOpeningWithMoves(_chessJS.history());if(null==opening)continue;inputValue=opening.opening.ECOCode}content+=`[${headers[i]} "${inputValue}"]\n`}}content+="\n";for(var fullMoveNumber=1,i=0;i<_boardStateHistory.moves.length;i+=2){var moveWhite;content+=`${fullMoveNumber}. ${_boardStateHistory.moves[i].san} `;var comment=_boardStateHistory.comments[i],moveBlack;if(null!=comment&&(comment=comment.trim()).length>0&&(content+=`{${comment}} `),i<_boardStateHistory.moves.length-1)content+=`${_boardStateHistory.moves[i+1].san} `,null!=(comment=_boardStateHistory.comments[i+1])&&(comment=comment.trim()).length>0&&(content+=`{${comment}} `);fullMoveNumber++}content+=result;var blob=new Blob([content],{type:"text/plain;charset=utf-8"}),link=document.createElement("a");link.setAttribute("href",URL.createObjectURL(blob)),link.setAttribute("download","game.pgn"),document.body.appendChild(link),link.click(),document.body.removeChild(link)}function selectOpening(opening){reset();for(var i=0;i<opening.movesNotation.length;i++){_chessJS.move(opening.movesNotation[i]),setCurrentBoardStateToChessJSBoard();var history=_chessJS.history({verbose:!0}),move=history[history.length-1];_boardStateHistory.add(move,_currentBoardState,"",!1)}updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateControlsOpeningDiv(),document.getElementById("controls-game-button-first-move").disabled=!1,document.getElementById("controls-game-button-previous-move").disabled=!1,document.getElementById("controls-game-button-next-move").disabled=!1,document.getElementById("controls-game-button-last-move").disabled=!1,document.getElementById("controls-game-button-save").disabled=!1}function selectRandomPuzzle(){reset();var puzzle=getRandomPuzzle();setCurrentBoardStateToFEN((_currentPuzzle=puzzle).FEN),_boardStateHistory.startingFEN=_currentPuzzle.FEN,_currentPuzzle.instructions.toLowerCase().includes("black")&&_boardStateHistory.add(null,_currentBoardState,"",!1),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateControlsOpeningDiv(),updateControlsPuzzleDiv(),document.getElementById("controls-reset-puzzle-button").disabled=!1,_stockfishEnabled>-1&&stockfishUpdate()}function setBoardHighlight(positionNotation,highlightType){for(var i=0;i<_boardHighlights.length;i++)if(_boardHighlights[i].position==positionNotation)return void(_boardHighlights[i].highlight=highlightType);_boardHighlights.push({position:positionNotation,highlight:highlightType}),updateBoardFromBoardState(_currentBoardState)}function setCurrentBoardStateByMoveIndex(moveIndex){var state=_boardStateHistory.states[moveIndex],FEN="";if(null==state){if(null!=_currentPuzzle)return void resetCurrentPuzzle();FEN=_boardStateHistory.startingFEN,_boardStateHistory.atIndex=0}else FEN=state.fen,_boardStateHistory.atIndex=moveIndex+1;_currentSquareSelected="",setCurrentBoardStateToFEN(FEN),boardCanvasClear(),clearBoardHighlights(),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateGameDetailsMoveCommentTextArea(),0==_stockfishEnabled&&stockfishUpdate()}function setCurrentBoardStateToChessJSBoard(){_currentBoardState=new BoardState}function setCurrentBoardStateToFEN(fen){_chessJS.load(fen),setCurrentBoardStateToChessJSBoard()}function setup(){buildBoardSquaresTable(),positionControlsDiv(),setupChessJS(),setCurrentBoardStateToChessJSBoard(),_boardStateHistory=new BoardStateHistory,(_boardDiv=document.getElementById("board-div")).addEventListener("contextmenu",event=>event.preventDefault()),_boardDraggingPieceDiv=document.getElementById("board-dragging-piece-div"),_stockfishMessageDiv=document.getElementById("controls-stockfish-message-div"),_stockfishLinesSelect=document.getElementById("controls-stockfish-lines-select"),stockfishPostMessage("uci"),loadOpenings(),loadPuzzles(),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),window.addEventListener("resize",window_resize)}function setupChessJS(){_chessJS.load("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}function stockfishBestMoveDecided(moveAsFromTo){if(-1!=_stockfishEnabled){var line,stockfishScore=_stockfishLines[_stockfishLines.length-1].score/100;stockfishScore>=0&&(stockfishScore="+"+stockfishScore);var move=getMoveForNotation(moveAsFromTo),moveValue;stockfishUpdateMessage(`Best move: <b>${null==move?moveAsFromTo:move.san}</b> (Score: ${stockfishScore}).`),("w"==_chessJS.turn()&&1==_stockfishEnabled||"b"==_chessJS.turn()&&2==_stockfishEnabled)&&(_stockfishTimeout=setTimeout(()=>{clearTimeout(_stockfishTimeout),_stockfishTimeout=null,makeMoveFromCurrentBoardStateFromTo(moveAsFromTo)},1e3))}}function stockfishSetOption(option,value){if(_stockfishIsReady){var valueInt;if("Skill Level"==option)value=Math.min(Math.max(parseInt(value),0),20);stockfishPostMessage(`setoption name "${option}" value ${value}`),-1!=_stockfishEnabled&&"Skill Level"==option&&stockfishUpdate()}}function stockfishPostMessage(message){console.log(`stockfishPostMessage: "${message}"`),_stockfish.postMessage(message)}function stockfishReceiveData(data){if(console.log(`stockfishReceiveData: "${data}"`),_stockfishIsReady){stockfishUpdateMessage("Ready.");var parts=data.split(" ");if("info"==parts[0])for(var score=0,i=0;i<parts.length;i++)if("cp"!=parts[i])if("pv"!=parts[i]);else{var movesNotation=[],chessJSAlt=new Chess;chessJSAlt.load(_chessJS.fen());for(var j=i+1;j<parts.length&&"bmc"!=parts[j];j++){var move=getMoveForNotation(parts[j],chessJSAlt);if(null==move)break;movesNotation.push(move.san),chessJSAlt.move(move.san)}_stockfishLines.push({score:score,movesNotation:movesNotation}),stockfishUpdateLines(),i+=movesNotation.length}else score=parseInt(parts[i+1]);"bestmove"==parts[0]&&stockfishBestMoveDecided(parts[1])}else"uciok"==data&&(_stockfishIsReady=!0)}function stockfishUpdate(move){if(_stockfishIsReady){if(_stockfishLines=[],null!=move){var moveAsFromTo=move.from+move.to;stockfishPostMessage("position fen "+_chessJS.fen()+" moves "+moveAsFromTo)}else stockfishPostMessage("position fen "+_chessJS.fen());stockfishUpdateMessage("Thinking..."),stockfishUpdateLines(),_stockfishTimeout=setTimeout(()=>{clearTimeout(_stockfishTimeout),_stockfishTimeout=null,stockfishPostMessage("go depth 10")},10)}}function stockfishUpdateLines(){var innerHTML="";if(_stockfishLines.length>0)for(var halfMoveCount=_chessJS.history().length,fullMoveCount=Math.floor(halfMoveCount/2),i=_stockfishLines.length-1;i>=0;i--){innerHTML+="<option>";var line=_stockfishLines[i],additionalHalfMoveCount="b"==_chessJS.turn()?1:0,score=line.score/100;score>=0&&(score="+"+score),innerHTML+=`[${score}] `;for(var j=0;j<line.movesNotation.length;j++)(j+additionalHalfMoveCount)%2==0&&(innerHTML+=`${Math.floor((2*fullMoveCount+j+additionalHalfMoveCount)/2)+1}. `),0==j&&1==additionalHalfMoveCount&&(innerHTML+="... "),innerHTML+=`${line.movesNotation[j]} `;innerHTML+="</option>"}_stockfishLinesSelect.innerHTML=innerHTML}function stockfishUpdateMessage(message){_stockfishMessageDiv.innerHTML=message}function updateBoardFromBoardState(boardState){_boardDiv.style.background="rgba(255, 255, 255, 0)",_boardDiv.style.backgroundImage=""!=_boardTheme.backgroundImage?`url(${_boardTheme.backgroundImage})`:"none";for(var bgColorIndex=0,rank=0;rank<8;rank++){for(var file=0;file<8;file++){var squareIndex=8*rank+file,squareValue=boardState.squares[squareIndex],positionNotation=getPositionNotationForRankAndFile(rank,file),boardSquareTD=document.getElementById(`board-square-td_${positionNotation}`),boardSquareTDImg=document.getElementById(`board-square-td-img_${positionNotation}`),bgColor=bgColorIndex%2==0?_boardTheme.light:_boardTheme.dark;if(boardSquareTD.style.backgroundColor=bgColor,boardSquareTDImg.style.cursor="default",boardSquareTDImg.style.transform=0==_boardOrientation?"scale(1, 1)":"scale(-1, -1)",boardSquareTDImg.style.filter=`drop-shadow(${_pieceset.shadowOffsetX}px ${_pieceset.shadowOffsetY}px ${_pieceset.shadowBlur}px ${_pieceset.shadowColor})`,7==rank||0==file){var boardSquareTDSpan=document.getElementById(`board-square-td-span_${positionNotation}-rank`);""!=_boardTheme.backgroundImage?boardSquareTDSpan.style.color=bgColorIndex%2==0?_boardTheme.labelDark:_boardTheme.labelLight:boardSquareTDSpan.style.color=bgColorIndex%2==0?_boardTheme.dark:_boardTheme.light,boardSquareTDSpan.style.transform=0==_boardOrientation?"scale(1.0,1.0)":"scale(-1.0,-1.0)",boardSquareTDSpan=document.getElementById(`board-square-td-span_${positionNotation}-file`),""!=_boardTheme.backgroundImage?boardSquareTDSpan.style.color=bgColorIndex%2==0?_boardTheme.labelDark:_boardTheme.labelLight:boardSquareTDSpan.style.color=bgColorIndex%2==0?_boardTheme.dark:_boardTheme.light,boardSquareTDSpan.style.transform=0==_boardOrientation?"scale(1.0,1.0)":"scale(-1.0,-1.0)"}for(var i=0;i<_boardHighlights.length;i++)if(_boardHighlights[i].position==positionNotation){var bgColorHighlight="white";""!=_boardTheme.backgroundImage?("check"==_boardHighlights[i].highlight&&(bgColorHighlight="rgba(255, 100, 100, 0.7)"),"checkmate"==_boardHighlights[i].highlight&&(bgColorHighlight="rgba(255, 0, 0, 0.85)"),"from"==_boardHighlights[i].highlight&&(bgColorHighlight="rgba(210, 210, 0, 0.5)"),"to"==_boardHighlights[i].highlight&&(bgColorHighlight="rgba(225, 225, 0, 0.5)")):("check"==_boardHighlights[i].highlight&&(bgColorHighlight="rgb(255, 100, 100)"),"checkmate"==_boardHighlights[i].highlight&&(bgColorHighlight="rgb(255, 0, 0)"),"from"==_boardHighlights[i].highlight&&(bgColorHighlight="rgb(210, 210, 0)"),"to"==_boardHighlights[i].highlight&&(bgColorHighlight="rgb(225, 225, 0)")),boardSquareTD.style.backgroundColor=bgColorHighlight;break}""==squareValue&&(boardSquareTDImg.src="assets/images/empty-0.png"),"P"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}pawn-0.${_pieceset.extension}`),"N"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}knight-0.${_pieceset.extension}`),"B"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}bishop-0.${_pieceset.extension}`),"R"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}rook-0.${_pieceset.extension}`),"Q"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}queen-0.${_pieceset.extension}`),"K"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}king-0.${_pieceset.extension}`),"p"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}pawn-1.${_pieceset.extension}`),"n"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}knight-1.${_pieceset.extension}`),"b"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}bishop-1.${_pieceset.extension}`),"r"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}rook-1.${_pieceset.extension}`),"q"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}queen-1.${_pieceset.extension}`),"k"==squareValue&&(boardSquareTDImg.src=`${_pieceset.path}king-1.${_pieceset.extension}`),""!=squareValue&&("w"==_chessJS.turn()?squareValue.toLowerCase()!=squareValue?boardSquareTDImg.style.cursor="grab":boardSquareTDImg.style.cursor="default":squareValue.toLowerCase()==squareValue?boardSquareTDImg.style.cursor="grab":boardSquareTDImg.style.cursor="default"),bgColorIndex++}bgColorIndex++}}function updateControlsFENInput(){var input;document.getElementById("controls-fen-input").value=_chessJS.fen()}function updateControlsMovesTable(){var controlsMovesTable=document.getElementById("controls-game-moves-table"),innerHTML="";if(null!=_boardStateHistoryLoadedGame)for(var divergenceFound=!1,i=0;i<Math.max(_boardStateHistory.moves.length,_boardStateHistoryLoadedGame.moves.length);i++){innerHTML+=`<tr><td style="text-align: center;">${i/2+1}. </td>`;for(var j=i;j<Math.min(i+2,Math.max(_boardStateHistory.moves.length,_boardStateHistoryLoadedGame.moves.length));j++){var moveBSH=_boardStateHistory.moves[j],moveBSHLG=_boardStateHistoryLoadedGame.moves[j],san="...",backgroundColor="white",foregroundColor;null!=moveBSH?(san=moveBSH.san,null==moveBSHLG?divergenceFound=!0:moveBSH.san!=moveBSHLG.san&&(divergenceFound=!0),j==_boardStateHistory.atIndex-1&&(backgroundColor=divergenceFound?"rgb(255,204,204)":"rgb(224,224,224)")):(san=moveBSHLG.san,j==_boardStateHistoryLoadedGame.atIndex-1&&(backgroundColor="rgb(224,224,224)")),innerHTML+=`<td id="controls-game-moves-table-td_${j}" class="controls-game-moves-table-cell" style="color: ${divergenceFound?"red":"black"} ; background-color: ${backgroundColor}" onmousedown="controlsGamesMovesTableCell_onMouseDown(${j})">${san}</td>`,null!=moveBSH&&null!=moveBSHLG&&moveBSH.san!=moveBSHLG.san&&(divergenceFound=!0)}innerHTML+="</tr>",i++}else for(var i=0;i<_boardStateHistory.moves.length;i++){innerHTML+=`<tr><td style="text-align: center;">${i/2+1}. </td>`;for(var j=i;j<Math.min(i+2,_boardStateHistory.moves.length);j++){var move=_boardStateHistory.moves[j],backgroundColor,san;innerHTML+=`<td id="controls-game-moves-table-td_${j}" class="controls-game-moves-table-cell" style="background-color: ${backgroundColor=j==_boardStateHistory.atIndex-1?"lightgray":"white"}" onmousedown="controlsGamesMovesTableCell_onMouseDown(${j})">${san=null!=move?move.san:"..."}</td>`}innerHTML+="</tr>",i++}controlsMovesTable.innerHTML=innerHTML}function updateControlsOpeningDiv(movesNotation){null==movesNotation&&(movesNotation=_chessJS.history());var controlsOpeningMatchingSpan=document.getElementById("controls-opening-matching-span");if(0==movesNotation.length)return controlsOpeningMatchingSpan.textContent="...",void populateOpeningMatchingSelect();var openings=getOpeningsWithMoves(movesNotation),textContent=controlsOpeningMatchingSpan.textContent;if(0==openings.length)"..."!=textContent&&(textContent=textContent.replace("...","").trim(),textContent+=" ...");else{var opening=openings[0];textContent=`(${opening.opening.ECOCode}) ${opening.opening.name}`}controlsOpeningMatchingSpan.textContent=textContent,populateOpeningMatchingSelect(openings)}function updateControlsPuzzleDiv(){var controlsPuzzleInfoDiv=document.getElementById("controls-puzzle-info-div"),innerHTML="";null!=_currentPuzzle&&(innerHTML=`<table><tr><td style="padding-top: 3px;">${_currentPuzzle.instructions} (${_currentPuzzle.description})</td>`,innerHTML+=`<td><img src="assets/images/info-0.png" width="20" height="20" title="${_currentPuzzle.solution}" style="padding-left: 10px; cursor: pointer;" onmousedown="alert('${_currentPuzzle.solution}');" /></td></tr></table>`),controlsPuzzleInfoDiv.innerHTML=innerHTML}function updateGameDetailsMoveCommentTextArea(){var comment=_boardStateHistory.comments[_boardStateHistory.atIndex];null==comment&&(comment=""),document.getElementById("controls-game-details-move-comment-text-area").value=comment}function boardDiv_onMouseDown(mouseEvent){var mousePosition={x:mouseEvent.clientX,y:mouseEvent.clientY};0!=mouseEvent.button?2==mouseEvent.button&&(_rightMouseDragPoints=[]).push(getBoardSquareCenterPosition(mousePosition)):boardCanvasClear()}function boardDiv_onMouseMove(mouseEvent){var mousePosition={x:mouseEvent.clientX,y:mouseEvent.clientY};if(null!=_rightMouseDragPoints&&mouseEvent.shiftKey){var point=getBoardSquareCenterPosition(mousePosition);if(pointArrayContains(_rightMouseDragPoints,point))return;_rightMouseDragPoints.push(point)}else if(""!=_currentSquareSelected){var position=getPositionForBoardDraggingPieceDivFromMouseEvent(mouseEvent),boardDraggingPieceDiv=document.getElementById("board-dragging-piece-div");boardDraggingPieceDiv.style.left=position.x+"px",boardDraggingPieceDiv.style.top=position.y+"px"}}function boardDiv_onMouseUp(mouseEvent){var mousePosition={x:mouseEvent.clientX,y:mouseEvent.clientY};if(2==mouseEvent.button&&null!=_rightMouseDragPoints){var to=getBoardSquareCenterPosition(mousePosition);pointArrayContains(_rightMouseDragPoints,to)||_rightMouseDragPoints.push(to),_rightMouseDragPoints.length<=1?mouseEvent.shiftKey?boardCanvasDrawSquare(to):boardCanvasDrawCircle(to):boardCanvasDrawArrowComplex(_rightMouseDragPoints),_rightMouseDragPoints=null}}function boardSquare_onMouseDown(mouseEvent,positionNotation){0==mouseEvent.button&&boardSquareSelected(positionNotation,"down")}function boardSquare_onMouseUp(mouseEvent,positionNotation){0==mouseEvent.button&&""!=_currentSquareSelected&&boardSquareSelected(positionNotation,"up")}function body_onKeyDown(keyboardEvent){var activeElementID=document.activeElement.id;if(!activeElementID.includes("input")&&!activeElementID.includes("select")){var keyCode=keyboardEvent.keyCode;37!=keyCode||document.getElementById("controls-game-button-previous-move").disabled?39!=keyCode||document.getElementById("controls-game-button-next-move").disabled?49!=keyCode?50!=keyCode?51!=keyCode||(_boardCanvasDrawColor="rgba(0,0,255,0.75)"):_boardCanvasDrawColor="rgba(0,255,0,0.75)":_boardCanvasDrawColor="rgba(255,0,0,0.75)":controlsGameButton_onClick("next"):controlsGameButton_onClick("previous")}}function body_onLoad(){setup()}function controlsBoardThemeSelect_onChange(){var select,index=document.getElementById("controls-board-theme-select").selectedIndex;_boardTheme=_boardThemes[index],updateBoardFromBoardState(_currentBoardState)}function controlsGameButton_onClick(descriptor){if("to-start"!=descriptor){if("previous"==descriptor){if(_boardInAnimation)return;return _boardStateHistory.atIndex=Math.max(_boardStateHistory.atIndex-2,-1),void setCurrentBoardStateByMoveIndex(_boardStateHistory.atIndex)}if("next"==descriptor){if(_boardInAnimation)return;_boardStateHistory.atIndex=Math.min(_boardStateHistory.atIndex,_boardStateHistory.moves.length-1);var move=_boardStateHistory.moves[_boardStateHistory.atIndex];return null==move&&(_boardStateHistory.atIndex++,move=_boardStateHistory.moves[_boardStateHistory.atIndex]),document.getElementById(`board-square-td-img_${move.from}`).src="assets/images/empty-0.png",boardCanvasClear(),setBoardHighlight(move.from,"from"),setBoardHighlight(move.to,"to"),void animateMove(move,()=>{if(setCurrentBoardStateByMoveIndex(_boardStateHistory.atIndex),setBoardHighlight(move.from,"from"),setBoardHighlight(move.to,"to"),_chessJS.in_check()||_chessJS.in_checkmate()){var value="w"==_chessJS.turn()?"K":"k",highlight=_chessJS.in_checkmate()?"checkmate":"check";setBoardHighlight(getPositionNotationForBoardSquareValue(value),highlight)}playSoundForMove(move)})}if("to-end"!=descriptor)"save"!=descriptor?"load"!=descriptor?"reset"!=descriptor?"save-image"!=descriptor||saveBoardAsImage():resetLoadedGame():document.getElementById("loadGameInput").click():saveGame();else{if(_boardInAnimation)return;setCurrentBoardStateByMoveIndex(_boardStateHistory.moves.length-1)}}else{if(_boardInAnimation)return;setCurrentBoardStateByMoveIndex(-1)}}function controlsGamesMovesTableCell_onMouseDown(index){if(setCurrentBoardStateByMoveIndex(index),0!=index){var move=_boardStateHistory.moves[index];setBoardHighlight(move.from,"from"),setBoardHighlight(move.to,"to"),animateMove(move,()=>{playSoundForMove(move)})}}function controlsOpeningInput_onInput(){populateOpeningSelect(document.getElementById("controls-opening-input").value)}function controlsOpeningMatchingSelect_onChange(){var select=document.getElementById("controls-opening-matching-select"),index=parseInt(select.value.split("_")[1]),movesNotation=_chessJS.history(),openings=getOpeningsWithMoves(movesNotation),opening;0!=openings.length&&selectOpening(openings[index].opening)}function controlsOpeningSelect_onChange(){var select=document.getElementById("controls-opening-select"),index=parseInt(select.value.split("_")[1]),opening;selectOpening(_openings[index])}function controlsPasteFENButton_onClick(){async function pasteFEN(){const FEN=await navigator.clipboard.readText();if(null!=FEN&&0!=FEN.length){var validate=_chessJS.validate_fen(FEN);validate.valid?(document.getElementById("controls-fen-input").value=FEN,reset(),setCurrentBoardStateToFEN(FEN),_boardStateHistory.startingFEN=FEN,"b"==_chessJS.turn()&&_boardStateHistory.add(null,_currentBoardState,"",!1),boardCanvasClear(),resetMoveClocks(),clearBoardHighlights(),updateBoardFromBoardState(_currentBoardState),updateControlsFENInput(),updateControlsMovesTable(),updateGameDetailsMoveCommentTextArea(),_stockfishEnabled>-1&&stockfishUpdate()):alert(`FEN string is invalid:\n"${validate.error}"`)}}pasteFEN()}function controlsPiecesetSelect_onChange(){var select=document.getElementById("controls-pieceset-select"),index=select.selectedIndex;_pieceset=_piecesets[select.selectedIndex],updateBoardFromBoardState(_currentBoardState)}function controlsRandomPuzzleButton_onClick(){selectRandomPuzzle()}function controlsResetPuzzleButton_onClick(){resetCurrentPuzzle()}function controlsStockfishSelect_onChange(){var select=document.getElementById("controls-stockfish-select");_stockfishEnabled=select.selectedIndex-1,_stockfishLines=[],null!=_stockfishTimeout&&clearTimeout(_stockfishTimeout),stockfishUpdateMessage("..."),stockfishUpdateLines(),_stockfishEnabled>-1&&(stockfishUpdateMessage("Ready."),stockfishUpdate());var skillLevelSelect=document.getElementById("controls-stockfish-skill-level-select");skillLevelSelect.disabled=!(_stockfishEnabled>-1),skillLevelSelect.style.opacity=_stockfishEnabled>-1?1:.3,document.getElementById("controls-stockfish-skill-level-span").style.opacity=_stockfishEnabled>-1?1:.3,_stockfishMessageDiv.style.opacity=_stockfishEnabled>-1?1:.3,_stockfishLinesSelect.disabled=!(_stockfishEnabled>-1),_stockfishLinesSelect.style.opacity=_stockfishEnabled>-1?1:.3}function controlsStockfishSkillLevelSelect_onChange(){var select;stockfishSetOption("Skill Level",document.getElementById("controls-stockfish-skill-level-select").value)}function controlsTimeSelect_onChange(){resetMoveClocks()}function flipBoardButton_onClick(){_boardOrientation=0==_boardOrientation?1:0,document.getElementById("board-squares-table").style.transform=0==_boardOrientation?"scale(1, 1)":"scale(-1, -1)",document.getElementById("board-canvas-1").style.transform=0==_boardOrientation?"scale(1, 1)":"scale(-1, -1)",document.getElementById("board-canvas-2").style.transform=0==_boardOrientation?"scale(1, 1)":"scale(-1, -1)",updateBoardFromBoardState(_currentBoardState)}function getDetailsMoveCommentTextArea_onInput(){var value=document.getElementById("controls-game-details-move-comment-text-area").value;_boardStateHistory.comments[_boardStateHistory.atIndex]=value}function hideControlsButton_onClick(){_controlsVisible=!1,document.getElementById("controls-div").style.display="none";var boardDivRect=_boardDiv.getBoundingClientRect(),boardDivSize=boardDivRect.right-boardDivRect.left,clientWidth=document.getElementsByTagName("body")[0].clientWidth;_boardDiv.style.transform=`translateX(${clientWidth/2-boardDivSize/2}px)`,document.getElementById("show-controls-button").style.display="block",document.getElementById("side-time-div").style.display="block"}function resetButton_onClick(){reset()}function showControlsButton_onClick(){_controlsVisible=!0,document.getElementById("controls-div").style.display="block";var content=document.getElementById("content");_boardDiv.style.transform="",document.getElementById("show-controls-button").style.display="none",document.getElementById("side-time-div").style.display="none"}function window_resize(){buildBoardSquaresTable(),updateBoardFromBoardState(_currentBoardState),positionControlsDiv()}